<!DOCTYPE html>
<html>
<!--
Copyright 2012 Gary R. Van Sickle (grvs@users.sourceforge.net).

This file is part of CoFlo.

CoFlo is free software: you can redistribute it and/or modify it under the
terms of version 3 of the GNU General Public License as published by the Free
Software Foundation.

CoFlo is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
CoFlo.  If not, see http://www.gnu.org/licenses/.
-->
<head>
	<title>TITLE</title>
	
	<meta name="generator" content="CoFlo 0.0.5">
	<meta http-equiv="text/html; charset=UTF-8">
	
	<!-- Dojo theme stylesheet. -->
	<!-- <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8/dijit/themes/claro/claro.css" media="screen"> -->
	<link rel="stylesheet" type="text/css" href="js/dojo-release-1.8.1-src/dijit/themes/claro/claro.css">
	
	<!-- CoFlo's CSS stylesheet -->
	<link rel="stylesheet" type="text/css" href="css/index.template.css">

	<!-- Set up the Dojo configuration.  We must do this in a separate <script> block prior to loading dojo.js. -->
	<script>
		var path_of_this_html_file = location.pathname.replace(/\/[^/]+$/, '');
		var url_of_this_files_directory = document.URL.replace(/[\\]/g, '/').replace(/\/[^/]+$/, '');
		console.log("document.URL=" + document.URL);
		console.log("url_of_this_files_directory="+url_of_this_files_directory);
		console.log("path_of_this_html_file="+path_of_this_html_file);
		console.log("Original document.domain=" + document.domain);
		dojoConfig = 
		{
				baseUrl: url_of_this_files_directory + /*path_of_this_html_file +*/ "/js/",
				tlmSiblingOfDojo: false,
				packages: [
					{ name: "dojo", location: "dojo-release-1.8.1-src/dojo" },
					{ name: "dijit", location: "dojo-release-1.8.1-src/dijit" },
					{ name: "dojox", location: "dojo-release-1.8.1-src/dojox" },
					{ name: "util", location: "dojo-release-1.8.1-src/util" },
					{ name: "coflo-report", location: "coflo", main: "coflo-report" }
				],
				has: {
					"dojo-firebug": true,
					"dojo-debug-messages": true
					},
				//requestProvider: "dojo/request/iframe",
				/* This should be an absolute path or problems arise with cross-site scripting. */
				dojoBlankHtmlUrl: url_of_this_files_directory + '/js/dojo-release-1.8.1-src/dojo/resources/blank.html',
				parseOnLoad: false,
				async: true    
		};
	</script>
	<!-- Load Dojo -->
	<!-- <script src="//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js"></script> -->
	<script src="js/dojo-release-1.8.1-src/dojo/dojo.js"></script>
	
	<script>
	// Dump the Dojo configuration to the console.
	require(["dojo/json", "dojo/_base/config", "dojo/domReady!"],
			function(JSON, config)
			{    
				// Dump the Dojo configuration to the console.
				console.log(JSON.stringify(config, true));
			});
	</script> 
	
	<script>
	// The BorderContainer widget which will be our top-level container for the individual panes.
	var appLayout;
	// The ObjectStore which contains the data for the navigation tree control.
	var myStore;
	// The navigation ContentPane widget.
	var navPane;
	// The central pane.
	var cfgstack;
	
	function handleError(error){
		  console.log(error.src, error.id);
		}
	require.on("error", handleError);
	
	/**
	 * Function for computing the priority number for the below ready() calls based on 
	 * the passed list of priority numbers of any ready() calls which must execute first.
	 * 
	 * @note I'm sure there's a better Dojo-specific way to do the equivalent of this, but afaict it's
	 * to write your own AMD modules, and my JavaScript skills aren't to that point yet. 
	 */
	function deps()
	{
		// The base priority is 1000, which is the default Dojo priority given to require's ready() callback.
		var result = 1000;
		if(arguments.length == 0)
		{
			// Caller doesn't depend on any other ready callbacks, return the base priority.
			return result;
		}
		for(var i=0; i<arguments.length; i++)
		{
			result = Math.max(result, arguments[i]);
		}
		// The priority is the max priority number of all dependencies, plus 1.
		result += 1;
		
		return result;
	}
	
	/* Create the Object Store which will back the navigation tree. */
	var priority_nav_store = deps();
	require(["dojo/store/Memory", "dojo/ready"], function(Memory, ready){
		ready(priority_nav_store, function(){
			
			console.log("Creating nav tree Object Store");
			
			// Create an in-memory store for the nav tree.
			myStore = new Memory({
				data: [
			            { id: 'all_files', name:'All Files', type:'theroot' },
	<!-- REMOVE_START -->
			            { id: 'file1_c', name:'file1.c', type:'file', parent: 'all_files' },
			            { id: 'func1', tabid: 'tabs-1', name:'function1', type:'function', parent: 'file1_c' },
						{ id: 'func2', tabid: 'tabs-2', name:'function2', type:'function', parent: 'file1_c' },
			            { id: 'file2_c', name:'file2.c', type:'file', parent: 'all_files' },
						{ id: 'func3', tabid: 'tabs-3', name:'function3', type:'function', parent: 'file2_c' }
	<!-- REMOVE_END -->
				 		<!-- TAB_LIST_START -->
				 		<!-- TAB_LIST_END -->
						],
		        getChildren: function(object){
		        	return this.query({parent: object.id});
		        	}
			});
			
			console.log("Created nav tree Object Store");
		});
	});
	
	/* Create the top-level layout container. */
	var priority_layout = deps();
	require(["dijit/layout/BorderContainer", "dojo/ready"], function(BorderContainer, ready){
		ready(priority_layout, function(){
			// Create the main layout BorderContainer.
			console.log("Creating BorderContainer");
			appLayout = new BorderContainer({
				design: "headline"
			}, "appLayout");
			console.log("Created BorderContainer");
		});
	});

 	/* Create the stack container. */
 	var priority_center_stack = deps(priority_layout);
 	require([
 	        "coflo-report",
			"dijit/layout/StackContainer",
            "dijit/layout/ContentPane",
			"dojo/aspect",
			"dojo/query",
            "dojo/dom-geometry",
            "./js/coflo.resizer.js",
			"dojo/ready"
 	        ],
 	        function(CoFloReport,
 	        		StackContainer,
 	        		ContentPane,
 	        		aspect,
 	        		query,
 	        		domGeom,
 	        		dummy,
 	        		ready)
 	{
 		ready(priority_center_stack, function()
 		{
			// Create the main content stack.
			console.log("Creating center stack, priority="+priority_center_stack);
			cfgstack = new StackContainer({
				region: "center",
				id: "cfgstack",
				"class": "centerPanel"}, "cfg-stack");
			
			// Create a resizing function object.
			var resize_hook = function(changeSize, resultSize){
				console.log("resize hook called");
				// Find the contained svg.
				var theDOMNode = this.domNode;
				var the_svg = query(".svg-cfg", theDOMNode);
				if(the_svg.length != 1)
				{
					// Should only be exactly one SVG in the pane.
					console.warn("Found ", the_svg.length, " SVG(s) in ", this, ", expected 1.");
				}
				else
				{
					// Resize the one and only svg object we've found.
					var intrinsic_width = getIntrinsicDimensions(the_svg[0]).width;
					var pane_width = domGeom.getContentBox(theDOMNode).w;
					var new_width = Math.min(intrinsic_width, changeSize.w);
					domGeom.setContentSize(the_svg[0], {w:new_width});
					//fitToContainer(the_svg[0], this.domNode);
					console.log(">>" + CoFloReport.something + CoFloReport.aMethod(the_svg[0], this));
				}
			};
			
			// Get a list of all the main content divs and create ContentPanes for them.
			var panes = query(".cfg-pane");
			panes.forEach(function(node, index, nodeList)
			{
				var cp = new ContentPane(
				{
					title: "Title Here",
					"class": "contentPane",
					preload: true,
					onLoad: function(data)
					{
						console.log("on load");
					}
				}, node);
				
				/*
				cp.set("onDownloadEnd", function(){
				    console.log("Download complete!");
				});
				if(index == 0)
				{
					//cp.set('content','<object class="svg-cfg" type="image/svg+xml" data="die.svg"></object>');
					cp.set('content','<embed src="die.svg" class="svg-cfg" type="image/svg+xml" />');
				}
				*/
				// Add a resize hook which will fit the SVG to the pane.
				cp.own(aspect.after(cp, "resize", resize_hook, true));
				
				cfgstack.addChild(cp);
			});
			// Add the widget we just created to the stack.
			appLayout.addChild(cfgstack);
			console.log("Created center stack, priority="+priority_center_stack);
 		});
 	});
 	
	/* Create the navigation pane. */
	var priority_nav_pane = deps(priority_layout, priority_nav_store, priority_center_stack);
 	require([
 	         "coflo-report",
			"dijit/tree/ObjectStoreModel",
			"dijit/Tree",
			"dijit/layout/ContentPane",
			"dojo/ready"],
			function(
				CoFloReport,
				ObjectStoreModel,
				Tree,
				ContentPane,
				ready){
 		ready(priority_nav_pane, function(){
		console.log("Creating Nav pane, priority="+priority_nav_pane);
		var myModel = new ObjectStoreModel({
			store: myStore,
			query: {id: 'all_files'},
			mayHaveChildren: function(item){
				return item.type != "function";
				}
			});
		
		var myTree = new Tree({
			model: myModel,
			id: "myTree",
			onOpenClick: true,
			onClick: function(item){
				if(item.type == "function")
				{
					console.log('Tab with tabid='+item.tabid+' was clicked.');
					cfgstack.selectChild(item.tabid, false);
				}
			}
		}, "nav-tree");
		
		// Create and add the navigation sidebar.
		navPane = new ContentPane({
			region: "left",
			id: "nav_pane",
			"class": "edgePanel",
			/*content: myTree,*/ /*"Sidebar content (left)",*/
			splitter: true}, "nav-pane");
		
		// Add the Digit tree control to the nav pane.
		navPane.addChild(myTree);
		appLayout.addChild(navPane);
		
		console.log("Created Nav pane, priority="+priority_nav_pane);
		});
	}); 	
 	
 	var priority_finish = deps(priority_center_stack, priority_nav_pane, priority_layout);
	require(["dojo/ready",
             "dijit/layout/ContentPane"
			],
             	function(ready, ContentPane)
             	{
    				ready(priority_finish, function()
					{
						// Create and add the Header pane.
						console.log("Running last ready(), priority="+priority_finish);
						var headerPane = new ContentPane({
							region: "top",
							"class": "edgePanel"
							/*content: "Header content (top)"*/
							}, "header_pane");
						appLayout.addChild(headerPane);
						
						// Start the CoFlo report browser app.
						appLayout.startup();
						console.log("Ran last ready(), priority="+priority_finish);
					});
             	});
    </script>
</head>

<body class="claro">

<!-- Div for the top-level layout container. -->
<div id="appLayout" class="demoLayout" data-dojo-type="dijit/layout/BorderContainer"
            data-dojo-props="design: 'headline'">

	<!-- The StackContainer making up the central panel. -->
	<div id="cfg-stack" class="centerPanel" data-dojo-type="dijit/layout/StackContainer"
	    data-dojo-props="region: 'center'" data-dojo-id="myStackContainer">
	
		<!-- The individual panes. -->
		<!-- REMOVE_START -->
		<div id="tabs-1" class="cfg-pane" data-dojo-type="dijit/layout/ContentPane" title="Questions">
			<!-- <object class="svg-cfg" type="image/svg+xml" data="die.svg"></object> -->
			<embed class="svg-cfg" src="die.svg" type="image/svg+xml" />
		</div>
		<div id="tabs-2" class="cfg-pane" data-dojo-type="dijit/layout/ContentPane" title="decode_switches">
		    <object class="svg-cfg" type="image/svg+xml" data="decode_switches.svg"></object>
		</div>
		<div id="tabs-3" class="cfg-pane" data-dojo-type="dijit/layout/ContentPane" title="Another die">
		    <object class="svg-cfg" type="image/svg+xml" data="die.svg"></object>
		</div>
		<!-- REMOVE_END -->
		
		<!-- TAB_PANEL_LIST_START -->
	 	<!-- TAB_PANEL_LIST_END -->

	</div>
	
	<!-- Div for the header pane. -->
	<div id="header_pane" class="edgePanel" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region: 'top'">
		<h1>CoFlo Analysis Results</h1>
	</div>
	
	<!-- Div for the navigation pane. -->
	<div id="nav-pane" class="edgePanel" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region: 'left', splitter: true">
		<!-- <h2>Navigation:</h2> -->
		<!-- Div for the tree control in the nav pane -->
		<div id="nav-tree"></div>
	</div>
</div>

</body>
</html>
